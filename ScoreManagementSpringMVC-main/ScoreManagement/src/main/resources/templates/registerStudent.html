<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Đăng ký tài khoản | Hệ thống quản lý điểm số</title>
    <th:block th:replace="base :: styles"></th:block>
    
</head>
<body>
    <div th:replace="base :: header"></div>

    <div class="register-container container">
        <div class="register-card card">
            <div class="register-header">
                <h2 class="register-title">
                    <i class="fas fa-user-plus"></i> Đăng ký tài khoản sinh viên
                </h2>
                <p class="text-white-50 mb-0">Nhập thông tin của bạn để tạo tài khoản</p>
            </div>
            
            <div class="register-form">
                <!-- Thông báo lỗi -->
                <div th:if="${param.error}" class="alert alert-danger mb-4">
                    <div th:if="${param.error == 'email'}">
                        <i class="fas fa-exclamation-circle me-2"></i> Email không hợp lệ hoặc không tồn tại trong hệ thống.
                    </div>
                    <div th:if="${param.error == 'password'}">
                        <i class="fas fa-exclamation-circle me-2"></i> Mật khẩu không khớp hoặc không đủ độ dài.
                    </div>
                    <div th:if="${param.error == 'avatar'}">
                        <i class="fas fa-exclamation-circle me-2"></i> Vui lòng chọn ảnh đại diện.
                    </div>
                    <div th:if="${param.error == 'email-format'}">
                        <i class="fas fa-exclamation-circle me-2"></i> Email phải là email do trường cấp (@dh.edu.com)
                    </div>
                    <div th:if="${param.error == 'avatar-required'}">
                        <i class="fas fa-exclamation-circle me-2"></i> Vui lòng chọn ảnh đại diện
                    </div>
                    <div th:if="${param.error == 'invalid-email'}">
                        <i class="fas fa-exclamation-circle me-2"></i> Email không tồn tại trong hệ thống hoặc đã được đăng ký
                    </div>
                    <div th:if="${param.error == 'system'}">
                        <i class="fas fa-exclamation-circle me-2"></i> Lỗi hệ thống, vui lòng thử lại sau
                    </div>
                </div>

                <form th:action="@{/registerStudent}" method="post" enctype="multipart/form-data">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="avatar-preview mb-4" id="avatarPreview">
                                <i class="fas fa-user"></i>
                            </div>
                            
                            <div class="mb-4">
                                <label for="avatar" class="form-label">Ảnh đại diện <span class="text-danger">*</span></label>
                                <input type="file" class="form-control" id="avatar" name="avatar" 
                                       accept="image/*" onchange="previewImage(event)" required>
                                <input type="hidden" id="base64Avatar" name="avatar">
                                <small class="form-text text-muted">Chọn ảnh đại diện (jpg, png, jpeg)</small>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-4">
                                <label for="email" class="form-label">Email sinh viên <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                                    <input type="email" class="form-control" id="email" name="email" 
                                           pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$" 
                                           placeholder="Nhập email trường cấp (@dh.edu.vn)" required>
                                </div>
                                <small class="form-text text-muted">Vui lòng sử dụng email do trường cấp (@dh.edu.vn)</small>
                            </div>

                            <div class="mb-4">
                                <label for="username" class="form-label">Tên đăng nhập <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-user"></i></span>
                                    <input type="text" class="form-control" id="username" name="username" 
                                           placeholder="Nhập tên đăng nhập" required>
                                </div>
                            </div>

                            <div class="mb-4">
                                <label for="password" class="form-label">Mật khẩu <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-lock"></i></span>
                                    <input type="password" class="form-control" id="password" name="password" 
                                           minlength="6" required>
                                    <button class="btn btn-outline-secondary toggle-password" type="button" data-target="password">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>

                            <div class="mb-4">
                                <label for="confirmPassword" class="form-label">Xác nhận mật khẩu <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-lock"></i></span>
                                    <input type="password" class="form-control" id="confirmPassword" 
                                           name="confirmPassword" minlength="6" required>
                                    <button class="btn btn-outline-secondary toggle-password" type="button" data-target="confirmPassword">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                <div id="passwordMismatch" class="invalid-feedback" style="display: none;">
                                    Mật khẩu xác nhận không khớp!
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="password-tips">
                        <h6><i class="fas fa-shield-alt me-2"></i>Yêu cầu mật khẩu:</h6>
                        <ul>
                            <li>Tối thiểu 6 ký tự</li>
                            <li>Nên kết hợp chữ cái và số</li>
                            <li>Không nên sử dụng thông tin cá nhân dễ đoán</li>
                        </ul>
                    </div>

                    <div class="mt-4 d-grid">
                        <button type="submit" class="btn btn-primary btn-register">
                            <i class="fas fa-user-plus me-2"></i> Đăng ký tài khoản
                        </button>
                    </div>
                </form>

                <div class="divider">
                    <span>hoặc</span>
                </div>

                <div class="text-center">
                    <p>Đã có tài khoản? <a th:href="@{/login}" class="text-primary fw-bold">Đăng nhập</a></p>
                </div>
            </div>
        </div>
    </div>

    <div th:replace="base :: footer"></div>

    <script>
        // Kiểm tra password match
        const password = document.getElementById("password");
        const confirm_password = document.getElementById("confirmPassword");
        const passwordMismatch = document.getElementById("passwordMismatch");

        function validatePassword() {
            if (password.value != confirm_password.value) {
                confirm_password.setCustomValidity("Mật khẩu không khớp");
                passwordMismatch.style.display = "block";
            } else {
                confirm_password.setCustomValidity('');
                passwordMismatch.style.display = "none";
            }
        }

        password.onchange = validatePassword;
        confirm_password.onkeyup = validatePassword;

        // Xử lý xem trước ảnh đại diện
        function previewImage(event) {
            const file = event.target.files[0];
            if (!file) return;

            const validTypes = ["image/png", "image/jpeg", "image/jpg"];
            if (!validTypes.includes(file.type)) {
                alert("Chỉ chấp nhận ảnh PNG, JPG hoặc JPEG!");
                event.target.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onloadend = function() {
                const base64String = reader.result;
                const base64Data = base64String.split(',')[1];
                document.getElementById('base64Avatar').value = base64Data;
                
                // Cập nhật xem trước ảnh
                const previewDiv = document.getElementById('avatarPreview');
                previewDiv.innerHTML = '';
                
                const img = document.createElement('img');
                img.src = base64String;
                previewDiv.appendChild(img);
            };
            reader.readAsDataURL(file);
        }
        
        // Xử lý hiển thị/ẩn mật khẩu
        document.querySelectorAll('.toggle-password').forEach(button => {
            button.addEventListener('click', function() {
                const targetId = this.getAttribute('data-target');
                const input = document.getElementById(targetId);
                
                if (input.type === 'password') {
                    input.type = 'text';
                    this.querySelector('i').classList.remove('fa-eye');
                    this.querySelector('i').classList.add('fa-eye-slash');
                } else {
                    input.type = 'password';
                    this.querySelector('i').classList.remove('fa-eye-slash');
                    this.querySelector('i').classList.add('fa-eye');
                }
            });
        });
    </script>
</body>
</html>