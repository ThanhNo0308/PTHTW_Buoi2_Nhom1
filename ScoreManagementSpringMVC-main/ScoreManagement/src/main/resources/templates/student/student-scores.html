<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
<head>
    <meta charset="UTF-8">
    <title>Xem Điểm</title>
    <th:block th:replace="base :: styles"></th:block>
</head>
<body>
    <div th:replace="base :: header"></div>
    
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>
                <i class="fas fa-chart-bar"></i> Bảng Điểm Cá Nhân
            </h2>
            
            <!-- Chọn năm học -->
            <div class="col-md-4">
                <label for="schoolYearSelect" class="form-label">Chọn năm học</label>
                <select class="form-select" id="schoolYearSelect">
                    <option value="">-- Chọn năm học --</option>
                    <option th:each="year : ${schoolYears}" 
                            th:value="${year.id}"
                            th:text="${year.yearStart + '-' + year.yearEnd + ' ' + year.semesterName}"
                            th:selected="${year.id == currentSchoolYear.id}">
                    </option>
                </select>
            </div>
        </div>
        
        <!-- Thông tin sinh viên -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Thông tin sinh viên</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-2">
                        <strong>Mã sinh viên:</strong> <span th:text="${student.studentCode}"></span>
                    </div>
                    <div class="col-md-4 mb-2">
                        <strong>Họ và tên:</strong> <span th:text="${student.firstName + ' ' + student.lastName}"></span>
                    </div>
                    <div class="col-md-3 mb-2">
                        <strong>Lớp:</strong> <span th:text="${student.classId.className}"></span>
                    </div>
                    <div class="col-md-2 mb-2">
                        <strong>Năm học:</strong> <span th:text="${currentSchoolYear.yearStart + '-' + currentSchoolYear.yearEnd}"></span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Bảng điểm -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Bảng điểm học kỳ <span th:text="${currentSchoolYear.semesterName}"></span></h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover" id="scoreTable">
                        <thead class="table-dark">
                            <tr>
                                <th>STT</th>
                                <th>Mã môn học</th>
                                <th>Tên môn học</th>
                                <th>Số tín chỉ</th>
                                <th>GK</th>
                                <th>CK</th>
                                <th>Điểm TB</th>
                                <th>Kết quả</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="score, stat : ${scores}">
                                <td th:text="${stat.index + 1}"></td>
                                <td th:text="${score.subjectTeacherID.subjectId.subjectCode}"></td>
                                <td th:text="${score.subjectTeacherID.subjectId.subjectName}"></td>
                                <td th:text="${score.subjectTeacherID.subjectId.credits}"></td>
                                <td th:text="${score.midtermScore != null ? #numbers.formatDecimal(score.midtermScore, 1, 1) : '-'}"></td>
                                <td th:text="${score.finalScore != null ? #numbers.formatDecimal(score.finalScore, 1, 1) : '-'}"></td>
                                <td th:text="${score.averageScore != null ? #numbers.formatDecimal(score.averageScore, 1, 1) : '-'}"></td>
                                <td>
                                    <span th:if="${score.averageScore != null && score.averageScore >= 5.0}" class="badge bg-success">Đạt</span>
                                    <span th:if="${score.averageScore != null && score.averageScore < 5.0}" class="badge bg-danger">Không đạt</span>
                                    <span th:if="${score.averageScore == null}" class="badge bg-secondary">Chưa có điểm</span>
                                </td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr class="table-info">
                                <th colspan="3">Điểm trung bình học kỳ</th>
                                <th th:text="${scores.isEmpty() ? 0 : #numbers.formatDecimal(scores.stream().filter(s -> s.averageScore != null).mapToDouble(s -> s.averageScore * s.subjectTeacherID.subjectId.credits).sum() / scores.stream().filter(s -> s.averageScore != null).mapToInt(s -> s.subjectTeacherID.subjectId.credits).sum(), 1, 2)}"></th>
                                <th colspan="4"></th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div th:replace="base :: footer"></div>
    
    <script>
        $(document).ready(function() {
            // Xử lý khi đổi năm học
            $('#schoolYearSelect').change(function() {
                const schoolYearId = $(this).val();
                if (schoolYearId) {
                    window.location.href = '/student-scores/by-schoolyear?schoolYearId=' + schoolYearId;
                }
            });
        });
    </script>
</body>
</html>